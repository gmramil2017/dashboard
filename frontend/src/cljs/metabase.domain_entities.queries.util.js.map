{"version":3,"sources":["metabase/domain_entities/queries/util.cljc"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAMA;;;mDAAA,nDAAKA;AAIL;;;sDAAA,mFAAA,zIAAKC,kMAEMC,wBAAQF;AAEnB;;;uDAAA,mFAAA,yDAAA,mFAAA,mDAAA,mFAAA,qFAAA,mFAAA,pkBAAKG,idAEmBD,mLAAsBF;AAE9C,AAAeI,4DACJ,AAACC,6CAAoBJ;AAGhC,AAAeK,6DACJ,AAACC,6CAAoBJ;AAGhC;;;;;;;yDAAA,zDAAkBK,0HAEfC;AAFH,AAAA;AAGE,IAAAC,WAEK,AAACC,6CAAK,WAAAC;AAAA,AAAA,IAAAC,aAAAD;WAAA,AAAAE,4CAAAD,WAAA,IAAA,lEAAME;WAAN,AAAAD,4CAAAD,WAAA,IAAA,lEAAWG;AAAX,AAAA,kDAAA,0DAAA,LAAyBD,qEAAiBC;sLAFhDP,mFAAAA,rQACAL,0FAAAA,uGAAAA,lMACA;AAFL,AAAA,4LAAAM,iFAAAA,rQAGKJ,2FAAAA,qGAAAA;;AAEP,oDAAA,pDAAOW,gHAAaC,MAAMC,cAAcC;;AAAxC,AACE,IAAMC,eAAa,4DAAA,wDAAA,vEAAKF,gEAAmBC;AAA3C,AACE,oBAAI,CAACF,sCAAAA,oDAAAA,hBAAMG,gCAAAA;AACT,eAAOH;eAAMC;eAAc,SAAA,RAAKC;;;;;;AAChCC;;;;;AAEN;;;;;;;+DAAA,/DAAkBC,sIAEfb,YACAU;AAHH,AAAA;AAIE,IAAMI,mBAAiB,cAAA,eAAA,mLAAId,mFAAAA,rQAAYL,0FAAAA,uGAAAA,jNAAiBoB,dAAKC;AAA7D,AACE,GAAI,AAACC,cAAI,CAACH,iDAAAA,gEAAAA,jBAAiBJ,4CAAAA;AACzBA;;AACA,IAAMQ,gBAAc,AAACC,qBAAW,CAAA,+DAAA,fAAST;IACnCU,aAAc,AAACJ,cAAI,+CAAA,WAAAK,1DAACC;AAAD,AAAS,IAAAC,mBAAI,6CAAAF,7CAACG,8DAAId;AAAT,AAAA,GAAAa;AAAAA;;AACI,0CAAAF,nCAACI,qBAAWP;;GACjBJ;AAHjC,AAIE,OAACN,kDAAYY,WAAWV,cAAc,AAACgB,gBAAMN","names":["metabase.domain-entities.queries.util/Expression","metabase.domain-entities.queries.util/ExpressionMap","cljs.core/string?","metabase.domain-entities.queries.util/ExpressionList","metabase.domain-entities.queries.util/->expression-map","metabase.domain-entities.converters/incoming","metabase.domain-entities.queries.util/expression-list->","metabase.domain-entities.converters/outgoing","metabase.domain-entities.queries.util/expressions-list","expressions","G__58546","cljs.core.mapv","p__58547","vec__58548","cljs.core.nth","name","expr","metabase.domain-entities.queries.util/unique-name","names","original-name","index","indexed-name","metabase.domain-entities.queries.util/unique-expression-name","expression-names","cljs.core/keys","cljs.core/set","cljs.core/not","re-duplicates","cljs.core/re-pattern","duplicates","p1__58551#","cljs.core.filter","or__5045__auto__","cljs.core._EQ_","cljs.core/re-matches","cljs.core/count"],"sourcesContent":["(ns metabase.domain-entities.queries.util\n  \"Utility functions used by the Queries in metabase-lib.\"\n  (:require\n   [metabase.util.malli :as mu]\n   #?@(:cljs ([metabase.domain-entities.converters :as converters]))))\n\n(def Expression\n  \"Schema for an Expression that's part of a query filter.\"\n  :any)\n\n(def ExpressionMap\n  \"Malli schema for a map of expressions by name.\"\n  [:map-of string? Expression])\n\n(def ExpressionList\n  \"Malli schema for a list of {:name :expression} maps.\"\n  [:vector [:map [:name string?] [:expression Expression]]])\n\n(def ^:private ->expression-map\n  #?(:cljs (converters/incoming ExpressionMap)\n     :clj  identity))\n\n(def ^:private expression-list->\n  #?(:cljs (converters/outgoing ExpressionList)\n     :clj  identity))\n\n(mu/defn ^:export expressions-list :- ExpressionList\n  \"Turns a map of expressions by name into a list of `{:name name :expression expression}` objects.\"\n  [expressions :- ExpressionMap]\n  (->> expressions\n       ->expression-map\n       (mapv (fn [[name expr]] {:name name :expression expr}))\n       expression-list->))\n\n(defn- unique-name [names original-name index]\n  (let [indexed-name (str original-name \" (\" index \")\")]\n    (if (names indexed-name)\n      (recur names original-name (inc index))\n      indexed-name)))\n\n(mu/defn ^:export unique-expression-name :- string?\n  \"Generates an expression name that's unique in the given map of expressions.\"\n  [expressions   :- ExpressionMap\n   original-name :- string?]\n  (let [expression-names (-> expressions ->expression-map keys set)]\n    (if (not (expression-names original-name))\n      original-name\n      (let [re-duplicates (re-pattern (str \"^\" original-name \" \\\\([0-9]+\\\\)$\"))\n            duplicates    (set (filter #(or (= % original-name)\n                                            (re-matches re-duplicates %))\n                                       expression-names))]\n        (unique-name duplicates original-name (count duplicates))))))\n"]}