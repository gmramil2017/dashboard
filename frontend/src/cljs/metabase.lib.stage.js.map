{"version":3,"sources":["metabase/lib/stage.cljc"],"mappings":"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","names":["metabase.lib.hierarchy/derive","metabase.lib.normalize/normalize","stage","metabase.lib.normalize.normalize_map","cljs.core/keyword","cljs.core.partial","cljs.core/mapv","metabase.lib.metadata.calculation/metadata-method","_query","_stage-number","_stage","cljs.core.ex_info","metabase.lib.stage/ensure-previous-stages-have-metadata","query","stage-number","cljs.core.reduce","metabase.lib.util.update_query_stage","cljs.core/assoc","metabase.lib.metadata.calculation.returned_columns","metabase.lib.util/query-stage","cljs.core.range","metabase.lib.util/canonical-stage-index","metabase.lib.stage/existing-stage-metadata","map__81166","cljs.core/--destructure-map","cljs.core.get","stage-type","source-card","or__5045__auto__","temp__5804__auto__","metadata","cljs.core._EQ_","source-type","G__81167","cljs.core/Keyword","js/Error","cljs.core/not-empty","iter__5523__auto__","s__81169","cljs.core/LazySeq","cljs.core/seq","cljs.core/chunked-seq?","c__5521__auto__","size__5522__auto__","cljs.core/count","b__81171","cljs.core/chunk-buffer","i__81170","cljs.core/-nth","cljs.core/chunk-append","cljs.core/chunk-cons","cljs.core/chunk","iter__81168","cljs.core/chunk-rest","cljs.core/first","cljs.core/cons","cljs.core/rest","col","cljs.core.merge","metabase.lib.stage/breakouts-columns","unique-name-fn","s__81180","b__81182","i__81181","iter__81179","breakout","metabase.lib.breakout/breakouts-metadata","cljs.core.assoc","cljs.core.some_fn","G__81186","G__81188","metabase.lib.field/desired-alias","metabase.lib.stage/aggregations-columns","s__81194","b__81196","i__81195","iter__81193","ag","metabase.lib.aggregation.aggregations_metadata","G__81201","G__81205","metabase.lib.stage/fields-columns","map__81213","fields","s__81215","b__81217","i__81216","vec__81221","cljs.core.nth","iter__81214","vec__81227","tag","ref-clause","source","G__81224","G__81230","metabase.lib.metadata.calculation.metadata","metabase.lib.metadata.calculation.column_name","G__81225","G__81232","metabase.lib.stage/summary-columns","cljs.core.into","cljs.core.mapcat","f","metabase.lib.stage/previous-stage-metadata","previous-stage-number","metabase.lib.util/previous-stage-number","s__81254","b__81256","i__81255","iter__81253","source-alias","cljs.core.dissoc","metabase.lib.stage/saved-question-metadata","card-id","card","metabase.lib.metadata/card","metabase.lib.metadata.calculation.visible_columns","p1__81268#","cljs.core.mapv","metabase.lib.stage/expressions-metadata","s__81293","b__81295","i__81294","iter__81292","expression","metabase.lib.expression.expressions_metadata","base-type","G__81305","G__81313","metabase.util.assoc_default","metabase.lib.stage/implicitly-joinable-columns","column-metadatas","existing-table-ids","cljs.core.map","cljs.core.comp","cljs.core.filter","medley.core.distinct_by","p__81325","map__81326","source-field-id","fk-target-field-id","metabase.lib.metadata/field","p1__81319#","cljs.core.remove","cljs.core/contains?","p__81329","map__81330","table-id","table-metadata","metabase.lib.metadata/table","options","s__81332","b__81334","i__81333","iter__81331","field","metabase.lib.metadata.calculation/visible-columns-method","G__81336","G__81339","p__81349","map__81350","metabase.lib.stage/previous-stage-or-source-visible-columns","cljs.core/fn?","p1__81340#","map__81351","source-table","this-stage","cljs.core/integer?","s__81353","b__81355","i__81354","iter__81352","G__81357","G__81358","p__81364","map__81366","metabase.lib.stage/existing-visible-columns","include-joined?","include-expressions?","cljs.core.concat","metabase.lib.join/all-joins-visible-columns","p__81377","vec__81378","metabase.lib.stage/ref-to?","_opts","pointer","clause","column","G__81381","metabase.lib.stage/mark-selected-breakouts","columns","temp__5802__auto__","breakouts","s__81390","b__81392","i__81391","iter__81389","match","p1__81384#","medley.core.find_first","map__81397","map__81400","binning","metabase.lib.binning/binning","unit","metabase.lib.temporal-bucket/temporal-bucket","G__81398","G__81404","metabase.lib.binning/with-binning","metabase.lib.temporal-bucket/with-temporal-bucket","p__81406","map__81407","include-implicitly-joinable?","existing-columns","metabase.lib.metadata.calculation/returned-columns-method","p__81411","map__81413","summary-cols","field-cols","cljs.core.doall","p1__81410#","metabase.lib.join/all-joins-expected-columns","metabase.lib.metadata.calculation/display-name-method","_style","metabase.shared.util.i18n/js-i18n","metabase.lib.stage/display-name-parts","style","descriptions","s__81427","b__81429","i__81428","iter__81426","k","metabase.lib.metadata.calculation.describe_top_level_key","clojure.string.join","clojure.string/blank?","metabase.lib.metadata.calculation.display_name","metabase.lib.stage/append-stage","cljs.core.update","cljs.core/conj","metabase.lib.stage/drop-stage","cljs.core/vec","cljs.core/butlast","cljs.core/chunk-first"],"sourcesContent":["(ns metabase.lib.stage\n  \"Method implementations for a stage of a query.\"\n  (:require\n   [clojure.string :as str]\n   [medley.core :as m]\n   [metabase.lib.aggregation :as lib.aggregation]\n   [metabase.lib.binning :as lib.binning]\n   [metabase.lib.breakout :as lib.breakout]\n   [metabase.lib.expression :as lib.expression]\n   [metabase.lib.field :as lib.field]\n   [metabase.lib.hierarchy :as lib.hierarchy]\n   [metabase.lib.join :as lib.join]\n   [metabase.lib.metadata :as lib.metadata]\n   [metabase.lib.metadata.calculation :as lib.metadata.calculation]\n   [metabase.lib.normalize :as lib.normalize]\n   [metabase.lib.schema :as lib.schema]\n   [metabase.lib.schema.id :as lib.schema.id]\n   [metabase.lib.temporal-bucket :as lib.temporal-bucket]\n   [metabase.lib.util :as lib.util]\n   [metabase.shared.util.i18n :as i18n]\n   [metabase.util :as u]\n   [metabase.util.malli :as mu]))\n\n(lib.hierarchy/derive :mbql.stage/mbql   ::stage)\n(lib.hierarchy/derive :mbql.stage/native ::stage)\n\n(defmethod lib.normalize/normalize :mbql.stage/mbql\n  [stage]\n  (lib.normalize/normalize-map\n   stage\n   keyword\n   {:aggregation (partial mapv lib.normalize/normalize)\n    :filters     (partial mapv lib.normalize/normalize)}))\n\n(defmethod lib.metadata.calculation/metadata-method ::stage\n  [_query _stage-number _stage]\n  ;; not i18n'ed because this shouldn't be developer-facing.\n  (throw (ex-info \"You can't calculate a metadata map for a stage! Use lib.metadata.calculation/returned-columns-method instead.\"\n                  {})))\n\n(mu/defn ensure-previous-stages-have-metadata :- ::lib.schema/query\n  \"Recursively calculate the metadata for the previous stages and add it to them, we'll need it for metadata\n  calculations for [[lib.metadata.calculation/returned-columns]] and [[lib.metadata.calculation/visible-columns]], and\n  we don't want to have to calculate it more than once...\"\n  [query        :- ::lib.schema/query\n   stage-number :- :int]\n  (reduce\n   (fn [query stage-number]\n     (lib.util/update-query-stage query\n                                  stage-number\n                                  assoc ::cached-metadata\n                                  (lib.metadata.calculation/returned-columns query\n                                                                             stage-number\n                                                                             (lib.util/query-stage query stage-number))))\n   query\n   (range 0 (lib.util/canonical-stage-index query stage-number))))\n\n(mu/defn ^:private existing-stage-metadata :- [:maybe lib.metadata.calculation/ColumnsWithUniqueAliases]\n  \"Return existing stage metadata attached to a stage if is already present: return it as-is, but only if this is a\n  native stage or a source-Card stage. if it's any other sort of stage then ignore the metadata, it's probably wrong;\n  we can recalculate the correct metadata anyway.\"\n  [query        :- ::lib.schema/query\n   stage-number :- :int]\n  (let [{stage-type :lib/type, :keys [source-card] :as stage} (lib.util/query-stage query stage-number)]\n    (or (::cached-metadata stage)\n        (when-let [metadata (:lib/stage-metadata stage)]\n          (when (or (= stage-type :mbql.stage/native)\n                    source-card)\n            (let [source-type (case stage-type\n                                :mbql.stage/native :source/native\n                                :mbql.stage/mbql   :source/card)]\n              (not-empty\n               (for [col (:columns metadata)]\n                 (merge\n                  {:lib/source-column-alias  (:name col)\n                   :lib/desired-column-alias (:name col)}\n                  col\n                  {:lib/source source-type})))))))))\n\n(mu/defn ^:private breakouts-columns :- [:maybe lib.metadata.calculation/ColumnsWithUniqueAliases]\n  [query          :- ::lib.schema/query\n   stage-number   :- :int\n   unique-name-fn :- fn?]\n  (not-empty\n   (for [breakout (lib.breakout/breakouts-metadata query stage-number)]\n     (assoc breakout\n            :lib/source               :source/breakouts\n            :lib/source-column-alias  ((some-fn :lib/source-column-alias :name) breakout)\n            :lib/desired-column-alias (unique-name-fn (lib.field/desired-alias query breakout))))))\n\n(mu/defn ^:private aggregations-columns :- [:maybe lib.metadata.calculation/ColumnsWithUniqueAliases]\n  [query          :- ::lib.schema/query\n   stage-number   :- :int\n   unique-name-fn :- fn?]\n  (not-empty\n   (for [ag (lib.aggregation/aggregations-metadata query stage-number)]\n     (assoc ag\n            :lib/source               :source/aggregations\n            :lib/source-column-alias  (:name ag)\n            :lib/desired-column-alias (unique-name-fn (:name ag))))))\n\n;;; TODO -- maybe the bulk of this logic should be moved into [[metabase.lib.field]], like we did for breakouts and\n;;; aggregations above.\n(mu/defn ^:private fields-columns :- [:maybe lib.metadata.calculation/ColumnsWithUniqueAliases]\n  [query          :- ::lib.schema/query\n   stage-number   :- :int\n   unique-name-fn :- fn?]\n  (when-let [{fields :fields} (lib.util/query-stage query stage-number)]\n    (not-empty\n     (for [[tag :as ref-clause] fields\n           :let                 [source (case tag\n                                          ;; you can't have an `:aggregation` reference in `:fields`; anything in\n                                          ;; `:aggregations` is returned automatically anyway\n                                          ;; by [[aggregations-columns]] above.\n                                          :field      :source/fields\n                                          :expression :source/expressions)\n                                 metadata (lib.metadata.calculation/metadata query stage-number ref-clause)]]\n       (assoc metadata\n              :lib/source               source\n              :lib/source-column-alias  (lib.metadata.calculation/column-name query stage-number metadata)\n              :lib/desired-column-alias (unique-name-fn (lib.field/desired-alias query metadata)))))))\n\n(mu/defn ^:private summary-columns :- [:maybe lib.metadata.calculation/ColumnsWithUniqueAliases]\n  [query          :- ::lib.schema/query\n   stage-number   :- :int\n   unique-name-fn :- fn?]\n  (not-empty\n   (into []\n         (mapcat (fn [f]\n                   (f query stage-number unique-name-fn)))\n         [breakouts-columns\n          aggregations-columns])))\n\n(mu/defn ^:private previous-stage-metadata :- [:maybe lib.metadata.calculation/ColumnsWithUniqueAliases]\n  \"Metadata for the previous stage, if there is one.\"\n  [query          :- ::lib.schema/query\n   stage-number   :- :int\n   unique-name-fn :- fn?]\n  (when-let [previous-stage-number (lib.util/previous-stage-number query stage-number)]\n    (not-empty\n     (for [col  (lib.metadata.calculation/returned-columns query\n                                                           previous-stage-number\n                                                           (lib.util/query-stage query previous-stage-number))\n           :let [source-alias (or ((some-fn :lib/desired-column-alias :lib/source-column-alias) col)\n                                  (lib.metadata.calculation/column-name query stage-number col))]]\n       (-> col\n           (assoc :lib/source               :source/previous-stage\n                  :lib/source-column-alias  source-alias\n                  :lib/desired-column-alias (unique-name-fn source-alias))\n           ;; do not retain `:temporal-unit`; it's not like we're doing a extract(month from <x>) twice, in both\n           ;; stages of a query. It's a little hacky that we're manipulating `::lib.field` keys directly here since\n           ;; they're presumably supposed to be private-ish, but I don't have a more elegant way of solving this sort\n           ;; of problem at this point in time.\n           (dissoc ::lib.field/temporal-unit))))))\n\n(mu/defn ^:private saved-question-metadata :- [:maybe lib.metadata.calculation/ColumnsWithUniqueAliases]\n  \"Metadata associated with a Saved Question, e.g. if we have a `:source-card`\"\n  [query          :- ::lib.schema/query\n   stage-number   :- :int\n   card-id        :- [:maybe ::lib.schema.id/card]\n   unique-name-fn :- fn?]\n  (when card-id\n    (when-let [card (lib.metadata/card query card-id)]\n      (->> (lib.metadata.calculation/visible-columns\n            query stage-number card {:unique-name-fn               unique-name-fn\n                                     :include-implicitly-joinable? false})\n           ;; Questions should not have implicitly joinable columns (#30950).\n           ;; :include-implicitly-joinable? false in the call above makes sure\n           ;; no implicitly joinable columns show up in the list, but this is\n           ;; not enough. If the returned columns contain :fk-target-field-id\n           ;; fields, then [[metabase.lib.metadata.calculation/visible-columns-method]]\n           ;; for :metabase.lib.stage/stage would add the implicitly joinable\n           ;; columns. Dissocing these fields prevents that.\n           (mapv #(dissoc % :fk-target-field-id))\n           not-empty))))\n\n(mu/defn ^:private expressions-metadata :- [:maybe lib.metadata.calculation/ColumnsWithUniqueAliases]\n  [query           :- ::lib.schema/query\n   stage-number    :- :int\n   unique-name-fn  :- fn?]\n  (not-empty\n   (for [expression (lib.expression/expressions-metadata query stage-number)]\n     (let [base-type (:base-type expression)]\n       (-> (assoc expression\n                  :lib/source               :source/expressions\n                  :lib/source-column-alias  (:name expression)\n                  :lib/desired-column-alias (unique-name-fn (:name expression)))\n           (u/assoc-default :effective-type (or base-type :type/*)))))))\n\n(defn- implicitly-joinable-columns\n  \"Columns that are implicitly joinable from some other columns in `column-metadatas`. To be joinable, the column has to\n  have appropriate FK metadata, i.e. have an `:fk-target-field-id` pointing to another Field. (I think we only include\n  this information for Databases that support FKs and joins, so I don't think we need to do an additional DB feature\n  check here.)\n\n  This does not include columns from any Tables that are already explicitly joined, and does not include multiple\n  versions of a column when there are multiple pathways to it (i.e. if there is more than one FK to a Table). This\n  behavior matches how things currently work in MLv1, at least for order by; we can adjust as needed in the future if\n  it turns out we do need that stuff.\n\n  Does not include columns that would be implicitly joinable via multiple hops.\"\n  [query stage-number column-metadatas unique-name-fn]\n  (let [existing-table-ids (into #{} (map :table-id) column-metadatas)]\n    (into []\n          (comp (filter :fk-target-field-id)\n                (m/distinct-by :fk-target-field-id)\n                (map (fn [{source-field-id :id, :keys [fk-target-field-id]}]\n                       (-> (lib.metadata/field query fk-target-field-id)\n                           (assoc ::source-field-id source-field-id))))\n                (remove #(contains? existing-table-ids (:table-id %)))\n                (m/distinct-by :table-id)\n                (mapcat (fn [{:keys [table-id], ::keys [source-field-id]}]\n                          (let [table-metadata (lib.metadata/table query table-id)\n                                options        {:unique-name-fn               unique-name-fn\n                                                :include-implicitly-joinable? false}]\n                            (for [field (lib.metadata.calculation/visible-columns-method query stage-number table-metadata options)\n                                  :let  [field (assoc field\n                                                      :fk-field-id              source-field-id\n                                                      :lib/source               :source/implicitly-joinable\n                                                      :lib/source-column-alias  (:name field))]]\n                              (assoc field :lib/desired-column-alias (unique-name-fn\n                                                                      (lib.field/desired-alias query field))))))))\n          column-metadatas)))\n\n;;; Calculate the columns to return if `:aggregations`/`:breakout`/`:fields` are unspecified.\n;;;\n;;; Formula for the so-called 'default' columns is\n;;;\n;;; 1a. Columns returned by the previous stage of the query (if there is one), OR\n;;;\n;;; 1b. Default 'visible' Fields for our `:source-table`, OR\n;;;\n;;; 1c. Metadata associated with a Saved Question, if we have `:source-card` (`:source-table` is a `card__<id>` string\n;;;     in legacy MBQL), OR\n;;;\n;;; 1d. `:lib/stage-metadata` if this is a `:mbql.stage/native` stage\n;;;\n;;; PLUS\n;;;\n;;; 2. Expressions (aka calculated columns) added in this stage\n;;;\n;;; PLUS\n;;;\n;;; 3. Columns added by joins at this stage\n(mu/defn ^:private previous-stage-or-source-visible-columns :- lib.metadata.calculation/ColumnsWithUniqueAliases\n  \"Return columns from the previous query stage or source Table/Card.\"\n  [query                                 :- ::lib.schema/query\n   stage-number                          :- :int\n   {:keys [unique-name-fn], :as options} :- lib.metadata.calculation/VisibleColumnsOptions]\n  {:pre [(fn? unique-name-fn)]}\n  (mapv\n   #(dissoc % ::lib.join/join-alias ::lib.field/temporal-unit ::lib.field/binning :fk-field-id)\n   (or\n    ;; 1a. columns returned by previous stage\n    (previous-stage-metadata query stage-number unique-name-fn)\n    ;; 1b or 1c\n    (let [{:keys [source-table source-card], :as this-stage} (lib.util/query-stage query stage-number)]\n      (or\n       ;; 1b: default visible Fields for the source Table\n       (when source-table\n         (assert (integer? source-table))\n         (let [table-metadata (lib.metadata/table query source-table)]\n           (lib.metadata.calculation/visible-columns query stage-number table-metadata options)))\n       ;; 1c. Metadata associated with a saved Question\n       (when source-card\n         (saved-question-metadata query stage-number source-card unique-name-fn))\n       ;; 1d: `:lib/stage-metadata` for the (presumably native) query\n       (for [col (:columns (:lib/stage-metadata this-stage))]\n         (assoc col\n                :lib/source :source/native\n                :lib/source-column-alias  (:name col)\n                ;; these should already be unique, but run them thru `unique-name-fn` anyway to make sure anything\n                ;; that gets added later gets deduplicated from these.\n                :lib/desired-column-alias (unique-name-fn (:name col)))))))))\n\n(mu/defn ^:private existing-visible-columns :- lib.metadata.calculation/ColumnsWithUniqueAliases\n  [query        :- ::lib.schema/query\n   stage-number :- :int\n   {:keys [unique-name-fn include-joined? include-expressions?], :as options} :- lib.metadata.calculation/VisibleColumnsOptions]\n  (concat\n   ;; 1: columns from the previous stage, source table or query\n   (previous-stage-or-source-visible-columns query stage-number options)\n   ;; 2: expressions (aka calculated columns) added in this stage\n   (when include-expressions?\n     (expressions-metadata query stage-number unique-name-fn))\n   ;; 3: columns added by joins at this stage\n   (when include-joined?\n     (lib.join/all-joins-visible-columns query stage-number unique-name-fn))))\n\n(defn- ref-to? [[tag _opts pointer :as clause] column]\n  (case tag\n    :field (if (or (number? pointer) (string? pointer))\n             (= pointer (:id column))\n             (throw (ex-info \"unknown type of :field ref in lib.stage/ref-to?\"\n                             {:clause clause\n                              :column column})))\n    :expression (= pointer (:name column))\n    (throw (ex-info \"unknown clause in lib.stage/ref-to?\"\n                    {:clause clause\n                     :column column}))))\n\n(defn- mark-selected-breakouts [query stage-number columns]\n  (if-let [breakouts (:breakout (lib.util/query-stage query stage-number))]\n    (for [column columns]\n      (if-let [match (m/find-first #(ref-to? % column) breakouts)]\n        (let [binning        (lib.binning/binning match)\n              {:keys [unit]} (lib.temporal-bucket/temporal-bucket match)]\n          (cond-> column\n            binning (lib.binning/with-binning binning)\n            unit    (lib.temporal-bucket/with-temporal-bucket unit)))\n        column))\n    columns))\n\n(defmethod lib.metadata.calculation/visible-columns-method ::stage\n  [query stage-number _stage {:keys [unique-name-fn include-implicitly-joinable?], :as options}]\n  (let [query            (ensure-previous-stages-have-metadata query stage-number)\n        existing-columns (existing-visible-columns query stage-number options)]\n    (->> (concat\n           existing-columns\n           ;; add implicitly joinable columns if desired\n           (when include-implicitly-joinable?\n             (implicitly-joinable-columns query stage-number existing-columns unique-name-fn)))\n         (mark-selected-breakouts query stage-number))))\n\n;;; Return results metadata about the expected columns in an MBQL query stage. If the query has\n;;; aggregations/breakouts, then return those and the fields columns. Otherwise if there are fields columns return\n;;; those and the joined columns. Otherwise return the defaults based on the source Table or previous stage + joins.\n(defmethod lib.metadata.calculation/returned-columns-method ::stage\n  [query stage-number _stage {:keys [unique-name-fn], :as options}]\n  (or\n   (existing-stage-metadata query stage-number)\n   (let [query        (ensure-previous-stages-have-metadata query stage-number)\n         summary-cols (summary-columns query stage-number unique-name-fn)\n         field-cols   (fields-columns query stage-number unique-name-fn)]\n     ;; ... then calculate metadata for this stage\n     (cond\n       summary-cols\n       (into summary-cols field-cols)\n\n       field-cols\n       (do (doall field-cols)           ; force generation of unique names before join columns\n           (into []\n                 (m/distinct-by #(dissoc % :source-alias :lib/source :lib/source-uuid :lib/desired-column-alias))\n                 (concat field-cols\n                         (lib.join/all-joins-expected-columns query stage-number options))))\n\n       :else\n       ;; there is no `:fields` or summary columns (aggregtions or breakouts) which means we return all the visible\n       ;; columns from the source or previous stage plus all the expressions. We return only the `:fields` from any\n       ;; joins\n       (concat\n        ;; we don't want to include all visible joined columns, so calculate that separately\n        (previous-stage-or-source-visible-columns query stage-number {:include-implicitly-joinable? false\n                                                                      :unique-name-fn               unique-name-fn})\n        (expressions-metadata query stage-number unique-name-fn)\n        (lib.join/all-joins-expected-columns query stage-number options))))))\n\n(defmethod lib.metadata.calculation/display-name-method :mbql.stage/native\n  [_query _stage-number _stage _style]\n  (i18n/tru \"Native query\"))\n\n(def ^:private display-name-parts\n  [:source-table\n   :source-card\n   :aggregation\n   :breakout\n   :filters\n   :order-by\n   :limit])\n\n(defmethod lib.metadata.calculation/display-name-method :mbql.stage/mbql\n  [query stage-number _stage style]\n  (let [query (ensure-previous-stages-have-metadata query stage-number)]\n    (or\n     (not-empty\n      (let [descriptions (for [k display-name-parts]\n                           (lib.metadata.calculation/describe-top-level-key query stage-number k))]\n        (str/join \", \" (remove str/blank? descriptions))))\n     (when-let [previous-stage-number (lib.util/previous-stage-number query stage-number)]\n       (lib.metadata.calculation/display-name query\n                                              previous-stage-number\n                                              (lib.util/query-stage query previous-stage-number)\n                                              style)))))\n\n(mu/defn append-stage :- ::lib.schema/query\n  \"Adds a new blank stage to the end of the pipeline\"\n  [query]\n  (update query :stages conj {:lib/type :mbql.stage/mbql}))\n\n(mu/defn drop-stage :- ::lib.schema/query\n  \"Drops the final stage in the pipeline\"\n  [query]\n  (when (= 1 (count (:stages query)))\n    (throw (ex-info (i18n/tru \"Cannot drop the only stage\") {:stages (:stages query)})))\n  (update query :stages (comp vec butlast)))\n"]}